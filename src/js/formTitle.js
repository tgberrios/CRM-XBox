// Datos JSON incluidos directamente en el HTML
const testData = {
  testCases: {
    "001-01": "Title Stability",
    "003-02": "Title Integrity",
    "003-03": "Options",
    "003-04": "Language Support",
    "003-05": "Navigation",
    "014-01": "Personal Information",
    "022-01": "Official Naming Standards",
    "001-03": "Title Stability after Connected Standby",
    "003-14": "Local Multiple Players",
    "057-01": "No Additional Purchases Required for Base Achievements",
    "112-03": "No Signed-In User",
    "112-04": "Active User Indication",
    "112-05": "Access to Account Picker",
    "115-01": "Addition of Users",
    "130-01": "Controller Input",
    "130-04": "Featured Game Modes",
    "131-01": "Game DVR and Screenshots - Console 1",
    "115-02": "Removal of Controllers",
    "055-01": "Achievements",
    "115-03": "Removal of Users",
    "003-17": "Headset State Change",
    "003-18": "Headset State Change after Suspend",
    "003-19": "Headset State Change after Connected Standby",
    "018-01":
      "Reporting Inappropriate Content and UGC Text-String Verification",
    "050-02": "Cloud Storage: Roaming [USE GOLD PROFILE]",
    "123-01":
      "Installation/Unlock of Game Add-Ons or Consumables During Gameplay",
    "130-02": "Save Game Roaming [USE GOLD PROFILE]",
    "003-10": "Cross Region",
    "064-01": "Joining a Game Session from Outside the Game",
    "064-02": "Joining a Game Session from the Same Game",
    "064-05": "Non-Joinable Game",
    "067-01": "Maintaining Session State",
    "015-02": "Muting Support  - (matrix on Voice tab)",
    "015-03": "Blocked Users - (matrix on Voice tab)",
    "124-01": "Game Invitations - (matrix on Invites&Joins tab)",
    "130-03": "Online Segmentation",
    "015-01": "User Communication",
    "045-01": "Respect User Privileges",
    "064-07": "Xbox Play Anywhere - Cross Platform",
    "003-07": "Leaderboards",
    "003-08": "Low or High Friend Count",
    "047-01": "User-Profile Access - (matrix on Gtag tab)",
    "001-02": "Title Stability After Suspending",
    "013-01": "Linking Microsoft Accounts with Publisher Accounts",
    "046-01": "Display Name and Gamerpic - (matrix on Gtag tab)",
    "048-01": "Profile Settings Usage - (matrix on Gtag tab)",
    "050-01": "Correct User Association",
    "052-01": "User Sign-In and Sign-Out",
    "052-02": "User Change During Suspended or Terminated State",
    "112-02": "Initial User and Controller",
    "112-08": "User Change During Suspension",
    "001-04": "Title Stability After Quick Resume",
    "130-05": "Compatibility Mode",
    "812-01": "Scarlett Performance",
    "074-01": "WAN Disconnection to Xbox Services",
    "074-02": "Direct Disconnection",
    "074-07": "Dynamic Connectivity Loss",
    "074-08": "Pre-Launch Downtime",
    "112-06": "Handling Profile Change",
    "129-01": "Intelligent Delivery of Language Packs",
    "129-02": "Intelligent Delivery of Device specific Content",
    "129-03": "Migration of Device Specific Content",
    "129-04": "Intelligent Delivery of On-Demand Content",
    "074-03": "Suspend Disconnection to Xbox Services",
    "074-04": "Xbox Service Reconnection During Suspend",
    "074-05": "Constant Low Bandwidth",
    "074-06": "Variable Low Bandwidth",
    "112-07": "User Change During Constrained Mode",
    "129-05": "Features and Recipes",
    "037-04": "Multiplayer DLC",
    "034-01": "Streaming Installation",
    "037-01": "No Content Package Save-Game Dependencies for Base Title",
    "037-02": "No Dependencies on Other Content Packages",
    "123-02":
      "Installation/Unlock of Game Add-Ons or Consumables as Part of Main Game Package During Streaming Install",
    "117-01": "Beta/Game Preview Notification to Users",
    "003-16": "Save-Game Compatibility",
    "037-03": "DLC Dependency",
    "036-01": "Content Price Verification",
    "070-01": "Xbox Friends List",
    "132-01": "Service Access Limitations",
    "132-02": "Game Event Limitations",
    "133-01": "Local Storage Write Limitations",
    "001-01.2": "Hardware Requirements",
    "003-00": "App is testable",
    "002-10": "General Security",
    "003-10": "Cross Region",
    "003-14": "Local Multiple Players",
    "003-17": "Headset State Change",
    "003-18": "Headset State Change after Suspend",
    "003-18": "Headset State Change after Connected Standby",
    "003-24": "Test Account",
    "004-02": "App Crash or Freeze",
    "004-03": "App Responsiveness",
    "037-03": "DLC Dependendy",
    "037-04": "Multiplayer DLC",
    "064-01": "Joining a Game Session from Outside the Game",
    "064-02": "Joining a Game Session from the Same Game",
    "064-05": "Non-Joinable Game",
    "064-07": "Xbox Play Anywhere - Cross Platform",
    "067-01": "Maintaning Session State",
    "124-01": "Game Invitations",
    "130-01": "Controller Input",
    "130-02": "Save Game Roaming",
    "130-03": "Online Segmentation",
    "130-04": "Featured Game Modes",
    "130-05": "Compatibility Mode",
    "131-01": "Game DVR and Screenshots",
    "132-01": "Service Access Limitations",
    "132-02": "Game Even Limitations",
    "133-01": "Local Storage Write Limitations",
    "812-01": "Scarlett Performance",
    "999-03": "Online - Only Metadata Verification",
    "999-90": "Optional Test Pass",
    "034-01": "Streaming Installation",
    "047-01": "User-Profile Access",
    "052-01": "User Sign-In and Sign-Out",
    "052-02": "User Change During Suspended or Terminated State",
    "057-01": "No Additional Purchases Required for Base Achievements",
    "112-02": "Initial User And Controller",
    "112-03": "No Signed-In User",
    "112-04": "Active User Indication",
    "112-05": "Access to Account Picker",
    "112-06": "Handling Profile Change",
    "112-07": "User Change During Constrained Mode",
    "112-08": "User Change During Suspension",
    "129-01": "Intelligent Delivery of Langueage Packs",
    "129-02": "Intelligent Delivery of Device specific Content",
    "129-03": "Migration of Device Specific Content",
    "129-04": "Intelligent Delivery of On-Demand Content",
    "129-05": "Features and Recipes",
    "003-07": "Leaderboards",
    "037-01": "No Content Package Save-Game Dependencies for Base Title",
    "037-02": "No Dependencies on Other Content Packages",
    "046-01": "Display Name and Gamerpic",
    "074-01": "WAN Disconnection to Xbox Services",
    "074-02": "Direct Disconnection",
    "074-03": "Suspend Disconnection to Xbox Services",
    "074-04": "Xbox Service Reconnection During Suspend",
    "074-07": "Dynamic Connectivity Loss",
    "074-08": "Pre-Lunch Downtime",
    "115-01": "Addition of Users",
    "115-02": "Removal of Controllers",
    "115-03": "Removal of Users",
    "123-01":
      "Installation/Unlock of Game Add-Ons or Consumables During Gameplay",
    "123-02":
      "Installation/Unlock of Game Add-Ons or Consumables as Part of Main Game Package During Streaming Install",
    "003-04": "Language Support",
    "003-08": "Low or High Friend Count",
    "036-01": "Content Price Verification",
    "048-01": "Profile Settings Usage",
    "070-01": "Xbox Friends List",
    "074-05": "Constant Low Bandwith",
    "074-06": "Variable Low Bandwith",
  },
  testModels: {
    TC5: [
      "001-01",
      "003-02",
      "003-16",
      "013-01",
      "014-01",
      "015-01",
      "015-02",
      "015-03",
      "018-01",
      "022-01",
      "045-01",
      "046-01",
      "048-01",
      "050-01",
      "050-02",
      "052-01",
      "052-02",
      "112-02",
      "112-08",
      "001-04",
      "130-05",
      "812-01",
    ],
    TC4: [
      "001-01",
      "003-02",
      "003-16",
      "013-01",
      "014-01",
      "015-01",
      "015-02",
      "015-03",
      "018-01",
      "022-01",
      "045-01",
      "046-01",
      "048-01",
      "050-01",
      "050-02",
      "052-01",
      "052-02",
      "112-02",
      "112-08",
      "001-04",
      "130-05",
      "812-01",
      "001-01.2",
      "001-02",
      "001-03",
      "001-04",
      "003-00",
      "002-10",
      "003-03",
      "003-10",
      "003-14",
      "003-17",
      "003-18",
      "003-19",
      "003-24",
      "004-02",
      "004-03",
      "037-03",
      "037-04",
      "064-01",
      "064-02",
      "064-05",
      "064-07",
      "067-01",
      "124-01",
      "130-01",
      "130-02",
      "130-03",
      "130-04",
      "130-05",
      "131-01",
      "132-01",
      "132-02",
      "133-01",
      "812-01",
      "999-03",
      "999-90",
    ],
    TC3: [
      "001-01",
      "003-02",
      "003-16",
      "013-01",
      "014-01",
      "015-01",
      "015-02",
      "015-03",
      "018-01",
      "022-01",
      "045-01",
      "046-01",
      "048-01",
      "050-01",
      "050-02",
      "052-01",
      "052-02",
      "112-02",
      "112-08",
      "001-04",
      "130-05",
      "812-01",
      "001-01.2",
      "001-02",
      "001-03",
      "001-04",
      "003-00",
      "002-10",
      "003-03",
      "003-10",
      "003-14",
      "003-17",
      "003-18",
      "003-19",
      "003-24",
      "004-02",
      "004-03",
      "037-03",
      "037-04",
      "064-01",
      "064-02",
      "064-05",
      "064-07",
      "067-01",
      "124-01",
      "130-01",
      "130-02",
      "130-03",
      "130-04",
      "130-05",
      "131-01",
      "132-01",
      "132-02",
      "133-01",
      "812-01",
      "999-03",
      "999-90",
      "034-01",
      "047-01",
      "052-01",
      "052-02",
      "057-01",
      "112-02",
      "112-03",
      "112-04",
      "112-05",
      "112-06",
      "112-07",
      "112-08",
      "129-01",
      "129-02",
      "129-03",
      "129-04",
      "129-05",
    ],
    TC2: [
      "001-01",
      "003-02",
      "003-16",
      "013-01",
      "014-01",
      "015-01",
      "015-02",
      "015-03",
      "018-01",
      "022-01",
      "045-01",
      "046-01",
      "048-01",
      "050-01",
      "050-02",
      "052-01",
      "052-02",
      "112-02",
      "112-08",
      "001-04",
      "130-05",
      "812-01",
      "001-01.2",
      "001-02",
      "001-03",
      "001-04",
      "003-00",
      "002-10",
      "003-03",
      "003-10",
      "003-14",
      "003-17",
      "003-18",
      "003-19",
      "003-24",
      "004-02",
      "004-03",
      "037-03",
      "037-04",
      "064-01",
      "064-02",
      "064-05",
      "064-07",
      "067-01",
      "124-01",
      "130-01",
      "130-02",
      "130-03",
      "130-04",
      "130-05",
      "131-01",
      "132-01",
      "132-02",
      "133-01",
      "812-01",
      "999-03",
      "999-90",
      "034-01",
      "047-01",
      "052-01",
      "052-02",
      "057-01",
      "112-02",
      "112-03",
      "112-04",
      "112-05",
      "112-06",
      "112-07",
      "112-08",
      "129-01",
      "129-02",
      "129-03",
      "129-04",
      "129-05",
      "003-07",
      "037-01",
      "037-02",
      "046-01",
      "074-01",
      "074-02",
      "074-03",
      "074-04",
      "074-07",
      "074-08",
      "115-01",
      "115-02",
      "115-03",
      "123-01",
      "123-02",
    ],
    TC1: [
      "001-01",
      "003-02",
      "003-16",
      "013-01",
      "014-01",
      "015-01",
      "015-02",
      "015-03",
      "018-01",
      "022-01",
      "045-01",
      "046-01",
      "048-01",
      "050-01",
      "050-02",
      "052-01",
      "052-02",
      "112-02",
      "112-08",
      "001-04",
      "130-05",
      "812-01",
      "001-01.2",
      "001-02",
      "001-03",
      "001-04",
      "003-00",
      "002-10",
      "003-03",
      "003-10",
      "003-14",
      "003-17",
      "003-18",
      "003-19",
      "003-24",
      "004-02",
      "004-03",
      "037-03",
      "037-04",
      "064-01",
      "064-02",
      "064-05",
      "064-07",
      "067-01",
      "124-01",
      "130-01",
      "130-02",
      "130-03",
      "130-04",
      "130-05",
      "131-01",
      "132-01",
      "132-02",
      "133-01",
      "812-01",
      "999-03",
      "999-90",
      "034-01",
      "047-01",
      "052-01",
      "052-02",
      "057-01",
      "112-02",
      "112-03",
      "112-04",
      "112-05",
      "112-06",
      "112-07",
      "112-08",
      "129-01",
      "129-02",
      "129-03",
      "129-04",
      "129-05",
      "003-07",
      "037-01",
      "037-02",
      "046-01",
      "074-01",
      "074-02",
      "074-03",
      "074-04",
      "074-07",
      "074-08",
      "115-01",
      "115-02",
      "115-03",
      "123-01",
      "123-02",
      "003-04",
      "003-08",
      "036-01",
      "048-01",
      "070-01",
      "074-05",
      "074-06",
    ],
  },
};

document.addEventListener("DOMContentLoaded", async () => {
  try {
    await loadTestData();
    populateTestModels(testData.testModels);

    const urlParams = new URLSearchParams(window.location.search);
    const editId = urlParams.get("editId");

    if (editId) {
      document.getElementById("formTitle").textContent = "Edit Tracker";
      await loadTracker(editId);
    }
  } catch (error) {
    console.error("Error during initialization", error);
  }
});

async function loadTestData() {
  try {
    const response = await fetch("./testData.json");
    if (!response.ok) {
      throw new Error("Network response was not ok");
    }
    testData = await response.json();
  } catch (error) {
    console.error("Failed to load test data", error);
  }
}

async function populateTestModels(testModels) {
  const testModelSelect = document.getElementById("testModel");
  testModelSelect.innerHTML = "";

  Object.keys(testModels).forEach((key) => {
    const option = document.createElement("option");
    option.value = key;
    option.textContent = key;
    testModelSelect.appendChild(option);
  });
}

async function loadTracker(id) {
  try {
    const tracker = await window.cert.loadTracker(id);
    if (tracker) {
      document.getElementById("titleName").value = tracker.titleName || "";
      document.getElementById("leadName").value = tracker.leadName || "";
      document.getElementById("testStartDate").value =
        tracker.testStartDate || "";
      document.getElementById("testEndDate").value = tracker.testEndDate || "";
      document.getElementById("sandboxIds").value = tracker.sandboxIds || "";
      document.getElementById("recoveryVersion").value =
        tracker.recoveryVersion || "";
      document.getElementById("binaryId").value = tracker.binaryId || "";
      document.getElementById("skuIdentifier").value =
        tracker.skuIdentifier || "";
      document.getElementById("xboxVersion").value = tracker.xboxVersion || "";
      document.getElementById("simplifiedUserModel").value =
        tracker.simplifiedUserModel || "";
      document.getElementById("windowsVersion").value =
        tracker.windowsVersion || "";
      document.getElementById("supportedPlatforms").value =
        tracker.supportedPlatforms || "";
      document.getElementById("testModel").value = tracker.testModel || "";
    }
  } catch (error) {
    console.error("Failed to load tracker", error);
  }
}

async function saveTracker() {
  const urlParams = new URLSearchParams(window.location.search);
  const editId = urlParams.get("editId");

  const tracker = {
    id: editId || `tracker-${Date.now()}`,
    titleName: document.getElementById("titleName").value,
    leadName: document.getElementById("leadName").value,
    testStartDate: document.getElementById("testStartDate").value,
    testEndDate: document.getElementById("testEndDate").value,
    sandboxIds: document.getElementById("sandboxIds").value,
    recoveryVersion: document.getElementById("recoveryVersion").value,
    binaryId: document.getElementById("binaryId").value,
    skuIdentifier: document.getElementById("skuIdentifier").value,
    xboxVersion: document.getElementById("xboxVersion").value,
    simplifiedUserModel: document.getElementById("simplifiedUserModel").value,
    windowsVersion: document.getElementById("windowsVersion").value,
    supportedPlatforms: document.getElementById("supportedPlatforms").value,
    testModel: document.getElementById("testModel").value,
    testCases: await getTestCases(document.getElementById("testModel").value),
  };

  try {
    await window.cert.saveTracker(tracker);
    alert("Tracker saved successfully.");
    window.location.href = "submissionManager.html";
  } catch (error) {
    console.error("Failed to save tracker", error);
    alert("Failed to save tracker.");
  }
}

async function getTestCases(testModel) {
  if (!testData.testModels[testModel]) {
    return []; // Return an empty array if the testModel is not found
  }

  return testData.testModels[testModel].map((id) => ({
    id: id,
    title: testData.testCases[id],
    comment: "",
    status: "", // Default status
  }));
}
